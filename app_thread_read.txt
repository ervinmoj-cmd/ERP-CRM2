
@app.route("/api/crm/deal/<int:deal_id>/thread-read", methods=["POST"])
@require_permission("crm")
def api_mark_thread_read(deal_id):
    """Mark all emails in a thread as read"""
    try:
        data = request.json
        thread_id = data.get('thread_id')
        if not thread_id:
            return jsonify({"success": False, "error": "Missing thread_id"}), 400
            
        with sqlite3.connect(DATABASE) as conn:
            c = conn.cursor()
            c.execute('''
                UPDATE email_history
                SET estado = 'leido'
                WHERE deal_id = ? AND thread_id = ? AND direccion = 'entrada' AND estado = 'recibido'
            ''', (deal_id, thread_id))
            conn.commit()
            
        return jsonify({"success": True})
    except Exception as e:
        print(f"Error marking thread read: {e}")
        return jsonify({"success": False, "error": str(e)}), 500
